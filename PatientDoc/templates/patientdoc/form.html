{% load static io %}
<form action="{% if new_doc %} 
                {% url 'document_create' member_id category_id %} 
            {% else %}
                {% url 'document_update' record_id %} 
            {% endif %}" method="post" enctype="multipart/form-data"
        show-spinner data-pjax data-pjax-container="modal" data-pjax-beforeSend="beforeSendCallback" data-pjax-success="successCallback">
    {% csrf_token %}
    <div class="modal-container">
        <div class="doc-input-base">
            <div class="overlay-scroll">
                <div class="doc-input-container">
                    {% for field in form %}
                    <div class="custom-input">
                        <div class="input-label">
                            <label>{{field.label}}</label>
                        </div>
                        <div class="input-box">
                            {{field}}
                        </div>
                    </div>
                    {% if field.errors %}
                    <div class="field-error clr-red">{{field.errors}}</div>
                    {% endif %}
                    {% endfor %}
                    <div class="doc-input-base-padding"></div>
                </div>
            </div>
            <div class="doc-buttons-base">
                <div class="text-submit-btn-container">
                    <div class="text-submit-btn btn-taint" tabindex="1" modal-close>
                        <span class="fs-22 clr-red icon-close"></span>
                    </div>
                </div>
                <div class="text-submit-btn-sep"></div>
                <div class="text-submit-btn-container">
                    <button type="submit" class="text-submit-btn btn-taint">
                        <span class="fs-22 clr-cyan icon-check"></span>
                    </button>
                </div>
            </div>
        </div>
        <div class="doc-upload-base">
            <div class="doc-upload-btn-base">
                <div class="doc-upload-btn">
                    <input id="idDocUpload" name="files" doc-upload class="doc-upload-input" type="file" accept=".jpg,.png,.bmp" multiple tabindex="1" />
                    <div class="doc-upload-btn-frame"></div>
                    <div class="doc-upload-btn-blinker"></div>
                    <div class="doc-upload-btn-blinker2"></div>
                </div>
                <div class="upload-files-container">
                    <div class="overlay-scroll">
                        <div id="idUploadList">
                            {% for file in atch_files %}
                            {% document_prop record_id file as doc_prop %}
                            <div class="file-upload-row server-storage">
                                <div class="file-upload-stored"></div>
                                <div class="thumbnail-container"><img src="{{doc_prop.path}}"></div>
                                <div class="file-upload-name"><span>{{doc_prop.name}}</span></div>
                                <div class="file-upload-size">{{doc_prop.size|filesizeformat}}</div>
                                <div class="file-upload-trash icon-trashfill" file-id="{{doc_prop.name}}"></div>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="spinner-base">
            <div class="spinner-pattern-container">
                <img src="{% static 'img/spinnerPattern.svg' %}" class="spinner-pattern1">
                <img src="{% static 'img/spinnerPattern.svg' %}" class="spinner-pattern2">
                <img src="{% static 'img/spinnerPattern.svg' %}" class="spinner-pattern3"> 
                <img src="{% static 'img/spinnerPattern.svg' %}" class="spinner-pattern4">  
                <img src="{% static 'img/spinnerPattern.svg' %}" class="spinner-pattern5"> 
                <img src="{% static 'img/spinnerPattern.svg' %}" class="spinner-pattern6"> 
                <img src="{% static 'img/spinnerPattern.svg' %}" class="spinner-pattern7">                                     
            </div>
            <div class="spinner-container">
                <div class="spinner-logo"></div>
            </div>
        </div>
    </div>
</form>

<script type="text/javascript">
    $('.overlay-scroll').overlayScrollbars({ 
        className       : "os-theme-dark",
        sizeAutoCapable : true,
        paddingAbsolute : true
    });

    
    var filesToUpload = [];
    var filesUploader = $("#idDocUpload").docFileUploader(filesToUpload, "#idUploadList");
    
    var filesToDelete = {};
    $(".file-upload-trash").click(function (e) {
        e.preventDefault();
        $(this).toggleClass('icon-trashfill icon-rotateright');
        $(this).toggleClass('file-upload-trash file-upload-revert bg-red');
        filesToDelete[$(this).attr('file-id')] = '';
    });
    $(".file-upload-revert").click(function (e) {
        e.preventDefault();
        $(this).toggleClass('icon-trashfill icon-rotateright');
        $(this).toggleClass('file-upload-trash file-upload-revert bg-red');
        delete filesToDelete[$(this).attr('file-id')];
    });

    function beforeSendCallback(options) {
        options.data.delete("files");
        for (var i = 0, len = filesToUpload.length; i < len; i++) {
            options.data.append("files", filesToUpload[i].file);
        }
        filesUploader.clear();
        
        options.data.delete("delete_files");
        var delete_keys = Object.keys(filesToDelete);
        for (var i = 0, len = delete_keys.length; i < len; i++) {
            options.data.append("delete_files", delete_keys[i]);
        }
    }

    function successCallback(options) {
        $.pjax({
            push: false,
            url: "{% url 'doc_cat' member_id category_id %}", 
            container: "#idDocCat",
            successCallback: "initCarousel",
        });
    }
</script>